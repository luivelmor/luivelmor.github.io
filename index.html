<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Investment Prep · Risk & Sizing</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        :root { --bg-gradient: radial-gradient(1400px 800px at 90% -10%, #f0f5ff 0, #ffffff 50%); }
        body { background: var(--bg-gradient); }
        .app-card{ border:0; border-radius:1.25rem; box-shadow:0 10px 30px rgba(16,24,40,.06),0 2px 6px rgba(16,24,40,.04) }
        .section-title{ font-size:.95rem; letter-spacing:.3px; text-transform:uppercase; color:#64748b }
        .metric{ display:grid; gap:.25rem }
        .metric .value{ font-size:clamp(1.25rem,2.2vw,1.75rem); font-weight:700; letter-spacing:.2px }
        .muted{ color:#6b7280; font-size:.9rem }
        .badge-pill{ border-radius:999px; padding:.45rem .7rem; font-weight:600 }
        .scale { display:flex; flex-wrap:wrap; gap:.5rem }
        .scale .card { padding:.5rem .7rem; border:0; border-radius:.75rem; box-shadow:0 1px 4px rgba(16,24,40,.08) }
        .scale .title { font-weight:700; font-size:.8rem; margin-right:.35rem }
        .scale .desc { font-size:.8rem }
        .active-band { outline:2px solid #0d6efd }
        .submetric{ font-size:.95rem; color:#475569 }

        /* % y gain TP */
        .tp-pct{
            font-weight:400;
            line-height:1.1;
            color:#111;
        }
        .tp-gain{
            font-weight:400;
            line-height:1.1;
            color:#111;
        }

        .is-note { font-size:.85rem; color:#0d6efd }
        .is-danger { color:#dc3545 }
    </style>
</head>
<body>
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10">
            <div class="card app-card">
                <div class="card-body p-4 p-lg-5">
                    <div class="d-flex align-items-start justify-content-between mb-4">
                        <div>
                            <h1 class="h3 mb-1">Investment Prep</h1>
                            <p class="text-secondary mb-0">ATR-based sizing with risk controls.</p>
                        </div>
                        <span class="badge text-bg-primary badge-pill">v3.4</span>
                    </div>

                    <!-- GLOBAL CURRENCY -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold me-2">Currency</label>
                        <select id="currencySelect" class="form-select w-auto d-inline-block">
                            <option value="$" selected>$</option>
                            <option value="€">€</option>
                        </select>
                        <small class="text-secondary ms-2">Applies to all monetary fields.</small>
                    </div>

                    <!-- BLOCK 1 · MARKET INPUTS -->
                    <div class="mb-3 section-title">Market inputs</div>
                    <div class="row g-4">
                        <div class="col-md-6">
                            <label for="price" class="form-label fw-semibold">Price</label>
                            <div class="input-group">
                                <span class="input-group-text currency">$</span>
                                <input type="number" inputmode="decimal" step="0.0001" min="0"
                                       class="form-control" id="price" value="100000" />
                            </div>
                            <div class="form-text">Execution or planned entry price.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="atr" class="form-label fw-semibold">ATR14</label>
                            <div class="input-group">
                                <span class="input-group-text currency">$</span>
                                <input type="number" inputmode="decimal" step="0.0001" min="0"
                                       class="form-control" id="atr" value="1000" />
                            </div>
                            <div class="form-text">Average True Range (14). Same currency as price.</div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- BLOCK 2 · VOLATILITY BASED RISK -->
                    <div class="mb-3 section-title">Volatility based risk</div>
                    <div class="row g-4 align-items-start">
                        <div class="col-md-4">
                            <div class="metric">
                                <span class="muted">ATR14 as % of Price</span>
                                <div class="d-flex align-items-center gap-2">
                                    <span id="atrPctBadge" class="badge text-bg-secondary badge-pill">-- %</span>
                                    <span id="atrPctText" class="value">-- %</span>
                                </div>
                                <small id="atrPctLabel" class="muted">—</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric">
                                <span class="muted">1R (absolute)</span>
                                <span id="oneR" class="value">—</span>
                                <small class="muted">Here 1R = ATR14.</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric">
                                <span class="muted">k (vol-adjusted)</span>
                                <div class="input-group">
                                    <input type="number" id="kInput" class="form-control form-control-lg" step="0.05" min="0.1" value="1.00" />
                                    <button id="resetKBtn" class="btn btn-outline-secondary">Auto</button>
                                </div>
                                <small id="kHint" class="muted">Auto suggestion: —</small>
                                <div class="scale mt-2" id="kScale">
                                    <div class="card" data-min="0" data-max="1"><span class="title">ATR% &lt; 1</span><span class="desc">k ≈ 1.5–2.0</span></div>
                                    <div class="card" data-min="1" data-max="2"><span class="title">1–2</span><span class="desc">k ≈ 1.0–1.5</span></div>
                                    <div class="card" data-min="2" data-max="3"><span class="title">2–3</span><span class="desc">k ≈ 0.75–1.0</span></div>
                                    <div class="card" data-min="3" data-max="5"><span class="title">3–5</span><span class="desc">k ≈ 0.50–0.75</span></div>
                                    <div class="card" data-min="5" data-max="1000"><span class="title">&gt;5</span><span class="desc">k ≈ 0.25–0.50</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- BLOCK 3 · RISK -->
                    <div class="mb-3 section-title">Risk</div>
                    <div class="row g-4">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold d-block">Fixed amount (Risk)</label>
                            <div class="input-group">
                                <span class="input-group-text currency">$</span>
                                <input type="number" id="riskAbsolute" class="form-control" step="1" min="0" value="25" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold d-block">% of Equity</label>
                            <div class="input-group">
                                <span class="input-group-text currency">$</span>
                                <input type="number" id="equity" class="form-control" step="1" min="0" value="100000" />
                                <span class="input-group-text">r%</span>
                                <input type="number" id="riskPct" class="form-control" step="0.05" min="0.05" value="0.5" />
                            </div>
                            <div class="form-text">Risk = Equity · (r/100). Syncs to “Fixed amount”.</div>
                        </div>

                        <div class="col-md-6">
                            <label for="leverage" class="form-label fw-semibold">Leverage (×)</label>
                            <input type="number" id="leverage" class="form-control" step="0.01" min="1" value="1.00" />
                            <div id="leverageHint" class="form-text">Kept ≤ max allowed by Free margin.</div>
                        </div>

                        <div class="col-md-6">
                            <label for="freeMargin" class="form-label fw-semibold">Free Margin</label>
                            <div class="input-group">
                                <span class="input-group-text currency">$</span>
                                <input type="number" id="freeMargin" class="form-control" step="1" min="0" value="150" />
                            </div>
                            <div class="form-text">Available margin to open new positions.</div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- BLOCK 4 · FINAL METRICS -->
                    <div class="mb-3 section-title">Final metrics</div>
                    <div class="row g-4">
                        <div class="col-md-4">
                            <div class="metric">
                                <span class="muted">Stop distance</span>
                                <span id="stopDistance" class="value">—</span>
                                <small class="muted">= ATR · k (same currency as price).</small>

                                <!-- NUEVO: PRECIO EXACTO DEL STOP -->
                                <span class="muted mt-1">Stop price</span>
                                <span id="stopPrice" class="value">—</span>
                                <small class="muted">Entry − Stop distance (long).</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric">
                                <span class="muted">Position size (units)</span>
                                <span id="positionSize" class="value">—</span>
                                <small class="muted">Risk / Stop distance (auto if Notional not overridden).</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Notional exposure</label>
                            <div class="input-group">
                                <span class="input-group-text currency">$</span>
                                <input type="number" id="notionalInput" class="form-control" step="0.01" min="0" />
                                <button id="notionalAutoBtn" class="btn btn-outline-secondary">Auto</button>
                            </div>
                            <small id="notionalHint" class="form-text">Auto: Units × Price. (Manual override off)</small>
                        </div>
                    </div>
                    <div class="row g-4 mt-1">
                        <div class="col-md-4">
                            <div class="metric">
                                <span class="muted">Required margin</span>
                                <span id="requiredMargin" class="value">—</span>
                                <small class="muted">= Notional / Leverage.</small>
                                <div id="maxLevNote" class="is-note mt-1">Max leverage allowed: —</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric">
                                <span class="muted">Margin usage</span>
                                <span id="marginUsage" class="value">—</span>
                                <small class="muted">Required margin / Equity.</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric">
                                <span class="muted">Chosen Risk</span>
                                <span id="chosenRisk" class="value">—</span>
                                <small class="muted">From fixed or Equity·r%.</small>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- BLOCK 5 · TAKE PROFITS -->
                    <div class="mb-3 section-title">Take profits</div>

                    <!-- A) TP factors -->
                    <div class="row g-3 align-items-end">
                        <div class="col-md-6 col-lg-4">
                            <label class="form-label fw-semibold">TP preset (×1R)</label>
                            <select id="tpPreset" class="form-select">
                                <option value="ultraConservative">Ultra-Conservative (0.25R, 0.5R, 1.0R)</option>
                                <option value="conservative">Conservative (0.5R, 1.0R, 1.5R)</option>
                                <option value="balanced">Balanced (0.75R, 1.5R, 2.5R)</option>
                                <option value="moderate" selected>Moderate (1.0R, 2.0R, 3.0R)</option>
                                <option value="aggressive">Aggressive (2.0R, 3.5R, 5.0R)</option>
                                <option value="ultraAggressive">Ultra-Aggressive (3.0R, 5.0R, 8.0R)</option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-4 mt-1">
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">TP1 factor (×1R)</label>
                            <input type="number" id="tp1f" class="form-control" step="0.25" min="0.25" value="1.0" />
                            <div class="metric mt-2">
                                <span class="muted">TP1 price</span>
                                <span id="tp1" class="value">—</span>
                                <span id="tp1pct" class="tp-pct">—</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">TP2 factor (×1R)</label>
                            <input type="number" id="tp2f" class="form-control" step="0.25" min="0.25" value="2.0" />
                            <div class="metric mt-2">
                                <span class="muted">TP2 price</span>
                                <span id="tp2" class="value">—</span>
                                <span id="tp2pct" class="tp-pct">—</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">TP3 factor (×1R)</label>
                            <input type="number" id="tp3f" class="form-control" step="0.25" min="0.25" value="3.0" />
                            <div class="metric mt-2">
                                <span class="muted">TP3 price</span>
                                <span id="tp3" class="value">—</span>
                                <span id="tp3pct" class="tp-pct">—</span>
                            </div>
                        </div>
                    </div>

                    <!-- B) Allocation preset -->
                    <div class="row g-3 align-items-end mt-4">
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Allocation preset (%)</label>
                            <select id="tpAllocPreset" class="form-select">
                                <option value="conservative" selected>Conservative (50%, 30%, 20%)</option>
                                <option value="moderate">Moderate (40%, 35%, 25%)</option>
                                <option value="aggressive">Aggressive (30%, 30%, 40%)</option>
                            </select>
                            <small id="allocNote" class="text-secondary d-block mt-1">Must sum 100% (auto-normalized if not).</small>
                        </div>
                    </div>

                    <!-- C) TP% inputs -->
                    <div class="row g-3 align-items-end mt-1">
                        <div class="col-md-4">
                            <label class="form-label">TP1 %</label>
                            <div class="input-group">
                                <input type="number" id="tp1pctAlloc" class="form-control" step="1" min="0" value="50" />
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">TP2 %</label>
                            <div class="input-group">
                                <input type="number" id="tp2pctAlloc" class="form-control" step="1" min="0" value="30" />
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">TP3 %</label>
                            <div class="input-group">
                                <input type="number" id="tp3pctAlloc" class="form-control" step="1" min="0" value="20" />
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                    </div>

                    <!-- D) Summary -->
                    <div class="row g-4 mt-2">
                        <div class="col-md-4">
                            <div class="submetric" id="tp1allocText">—</div>
                            <div class="tp-gain" id="tp1gainText">—</div>
                        </div>
                        <div class="col-md-4">
                            <div class="submetric" id="tp2allocText">—</div>
                            <div class="tp-gain" id="tp2gainText">—</div>
                        </div>
                        <div class="col-md-4">
                            <div class="submetric" id="tp3allocText">—</div>
                            <div class="tp-gain" id="tp3gainText">—</div>
                        </div>
                    </div>

                    <!-- Totals -->
                    <div class="row g-4 mt-3">
                        <div class="col-md-6">
                            <div class="metric">
                                <span class="muted">Planned realized PnL (sum of allocations)</span>
                                <span id="plannedPnl" class="value">—</span>
                                <small class="muted">Based on current position size and allocation %.</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="metric">
                                <span class="muted">Planned RR (reward / risk)</span>
                                <span id="plannedRR" class="value">—</span>
                                <small class="muted">Planned PnL / Chosen Risk.</small>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 d-flex gap-2">
                        <button id="resetBtn" class="btn btn-outline-secondary btn-sm">Reset</button>
                        <button id="prefillBtn" class="btn btn-outline-primary btn-sm">Prefill demo</button>
                    </div>
                </div>
            </div>

            <p class="text-center text-muted mt-4 mb-0">
                Tip: Stop = ATR · k. Position size = Risk / Stop. Margin = Notional / Leverage. TP = Price + (factor × Stop).
            </p>
        </div>
    </div>
</div>

<script>
    (function extraColors(){
        const st=document.createElement('style');
        st.textContent=`
          .text-bg-teal{color:#fff;background:#14b8a6!important}
          .text-bg-orange{color:#fff;background:#f59e0b!important}
        `;
        document.head.appendChild(st)
    })();

    // Elements
    const currencySelect = document.getElementById('currencySelect');
    const priceEl = document.getElementById('price');
    const atrEl = document.getElementById('atr');
    const atrPctText = document.getElementById('atrPctText');
    const atrPctBadge = document.getElementById('atrPctBadge');
    const atrPctLabel = document.getElementById('atrPctLabel');
    const oneREl = document.getElementById('oneR');
    const kInput = document.getElementById('kInput');
    const kScale = document.getElementById('kScale');
    const resetKBtn = document.getElementById('resetKBtn');
    const kHint = document.getElementById('kHint');

    const riskAbsEl = document.getElementById('riskAbsolute');
    const equityEl = document.getElementById('equity');
    const riskPctEl = document.getElementById('riskPct');
    const leverageEl = document.getElementById('leverage');
    const freeMarginEl = document.getElementById('freeMargin');

    const stopDistanceEl = document.getElementById('stopDistance');
    const stopPriceEl = document.getElementById('stopPrice');   // NUEVO
    const positionSizeEl = document.getElementById('positionSize');
    const notionalInput = document.getElementById('notionalInput');
    const notionalAutoBtn = document.getElementById('notionalAutoBtn');
    const notionalHint = document.getElementById('notionalHint');
    const requiredMarginEl = document.getElementById('requiredMargin');
    const marginUsageEl = document.getElementById('marginUsage');
    const chosenRiskEl = document.getElementById('chosenRisk');
    const maxLevNote = document.getElementById('maxLevNote');
    const leverageHint = document.getElementById('leverageHint');

    const tpPreset = document.getElementById('tpPreset');
    const tp1f = document.getElementById('tp1f');
    const tp2f = document.getElementById('tp2f');
    const tp3f = document.getElementById('tp3f');
    const tp1 = document.getElementById('tp1');
    const tp2 = document.getElementById('tp2');
    const tp3 = document.getElementById('tp3');
    const tp1pct = document.getElementById('tp1pct');
    const tp2pct = document.getElementById('tp2pct');
    const tp3pct = document.getElementById('tp3pct');

    const tpAllocPreset = document.getElementById('tpAllocPreset');
    const tp1pctAlloc = document.getElementById('tp1pctAlloc');
    const tp2pctAlloc = document.getElementById('tp2pctAlloc');
    const tp3pctAlloc = document.getElementById('tp3pctAlloc');

    const tp1allocText = document.getElementById('tp1allocText');
    const tp2allocText = document.getElementById('tp2allocText');
    const tp3allocText = document.getElementById('tp3allocText');
    const tp1gainText = document.getElementById('tp1gainText');
    const tp2gainText = document.getElementById('tp2gainText');
    const tp3gainText = document.getElementById('tp3gainText');

    const plannedPnl = document.getElementById('plannedPnl');
    const plannedRR = document.getElementById('plannedRR');

    // Helpers
    function toNum(v){ if(typeof v!=='string') return NaN; return parseFloat(v.replace(',', '.')); }
    function fmt(x,min=0,max=2){ if(!Number.isFinite(x)) return '—'; return x.toLocaleString(undefined,{minimumFractionDigits:min,maximumFractionDigits:max}); }
    function fmtAuto(x){
        if(!Number.isFinite(x)) return '—';
        const a=Math.abs(x);
        const d=a>=1000?0:a>=100?1:a>=10?2:a>=1?3:4;
        return x.toLocaleString(undefined,{minimumFractionDigits:d,maximumFractionDigits:d});
    }
    function classifyPct(p){
        if(p<1) return {cls:'text-bg-success',label:'Very low'};
        if(p<2) return {cls:'text-bg-teal',label:'Low'};
        if(p<3) return {cls:'text-bg-warning',label:'Moderate'};
        if(p<5) return {cls:'text-bg-orange',label:'High'};
        return {cls:'text-bg-danger',label:'Very high'};
    }
    function suggestedK(pct){
        if (!Number.isFinite(pct)) return {k:1, band:'—'};
        if (pct < 1) return {k:1.75, band:'ATR% < 1 → k≈1.5–2.0'};
        if (pct < 2) return {k:1.25, band:'ATR% 1–2 → k≈1.0–1.5'};
        if (pct < 3) return {k:0.90, band:'ATR% 2–3 → k≈0.75–1.0'};
        if (pct < 5) return {k:0.60, band:'ATR% 3–5 → k≈0.50–0.75'};
        return {k:0.35, band:'ATR% > 5 → k≈0.25–0.50'};
    }
    function highlightBand(pct){
        [...kScale.children].forEach(card=>{
            const min=parseFloat(card.dataset.min), max=parseFloat(card.dataset.max);
            card.classList.toggle('active-band', (pct>=min && pct<max));
        });
    }
    function applyCurrencySymbol(sym){
        document.querySelectorAll('.currency').forEach(el=>el.textContent = sym);
        update();
    }
    function syncRiskEuro(){
        const eq=Math.max(0, toNum(equityEl.value));
        const r=Math.max(0, toNum(riskPctEl.value))/100;
        const risk=eq*r;
        if (Number.isFinite(risk)) riskAbsEl.value = risk.toFixed(2);
    }
    function applyPreset(name){
        const presets = {
            ultraConservative: [0.25, 0.5, 1.0],
            conservative:      [0.5, 1.0, 1.5],
            balanced:          [0.75, 1.5, 2.5],
            moderate:          [1.0, 2.0, 3.0],
            aggressive:        [2.0, 3.5, 5.0],
            ultraAggressive:   [3.0, 5.0, 8.0]
        };
        const [a,b,c] = presets[name] || presets.moderate;
        tp1f.value = a; tp2f.value = b; tp3f.value = c;
    }
    function applyAllocPreset(name){
        const presets = {
            conservative: [50, 30, 20],
            moderate:     [40, 35, 25],
            aggressive:   [30, 30, 40]
        };
        const [a,b,c] = presets[name] || presets.conservative;
        tp1pctAlloc.value = a; tp2pctAlloc.value = b; tp3pctAlloc.value = c;
    }

    // State
    let kOverridden = false;
    let notionalOverridden = false;

    function update(){
        const sym = currencySelect.value;
        const price=toNum(priceEl.value);
        const atr=toNum(atrEl.value);
        const equity=Math.max(0, toNum(equityEl.value));
        let leverage=Math.max(1, toNum(leverageEl.value));
        const freeMargin=Math.max(0, toNum(freeMarginEl.value));
        const riskEuro = Math.max(0, toNum(riskAbsEl.value));

        const valid=Number.isFinite(price)&&price>0&&Number.isFinite(atr)&&atr>=0;
        if (!valid){
            [atrPctText,atrPctLabel,oneREl,stopDistanceEl,stopPriceEl,positionSizeEl,
                requiredMarginEl,marginUsageEl,chosenRiskEl,
                plannedPnl,plannedRR,tp1,tp2,tp3,tp1pct,tp2pct,tp3pct,
                tp1allocText,tp2allocText,tp3allocText,tp1gainText,tp2gainText,tp3gainText]
                .forEach(el=>el.textContent='—');
            atrPctBadge.textContent='-- %';
            atrPctBadge.className='badge text-bg-secondary badge-pill';
            notionalInput.value = '';
            notionalHint.textContent='Auto: Units × Price. (Manual override off)';
            maxLevNote.textContent = 'Max leverage allowed: —';
            leverageEl.classList.remove('is-invalid');
            leverageHint.textContent = 'Kept ≤ max allowed by Free margin.';
            return;
        }

        // ATR%
        const atrPct=(atr/price)*100;
        const cls=classifyPct(atrPct);
        atrPctText.textContent=fmt(atrPct,2,2)+' %';
        atrPctBadge.textContent=fmt(atrPct,2,2)+'%';
        atrPctBadge.className=`badge ${cls.cls} badge-pill`;
        atrPctLabel.textContent=cls.label;

        // 1R
        oneREl.textContent = sym + ' ' + fmtAuto(atr);

        // k
        const {k, band}=suggestedK(atrPct);
        highlightBand(atrPct);
        if (!kOverridden) kInput.value = k.toFixed(2);
        kHint.textContent = `Auto suggestion: ${k.toFixed(2)} (${band})` + (kOverridden ? ' · overridden' : '');
        const kActive = toNum(kInput.value);

        // Stop distance y precio del stop
        const stop = atr * (Number.isFinite(kActive)?kActive:1);
        stopDistanceEl.textContent = sym + ' ' + fmtAuto(stop);

        const stopPrice = price - stop; // LONG
        stopPriceEl.textContent = sym + ' ' + fmtAuto(stopPrice);

        // ---------- Units, Notional, Leverage & Margin ----------
        let units, notional;

        if (notionalOverridden) {
            notional = Math.max(0, toNum(notionalInput.value));
            if (freeMargin > 0 && notional > 0) {
                const levNeeded = notional / freeMargin;
                if (!Number.isFinite(leverage) || leverage < levNeeded) {
                    leverage = Math.max(1, levNeeded);
                    leverageEl.value = leverage.toFixed(2);
                }
            }
            units = price > 0 ? (notional / price) : NaN;

        } else {
            const unitsByRisk   = stop > 0 ? (riskEuro / stop) : 0;
            const allowedNotion = freeMargin * Math.max(1, leverage);
            const unitsByMargin = price > 0 ? (allowedNotion / price) : 0;

            units   = Math.min(unitsByRisk, unitsByMargin);
            notional = units * price;
            notionalInput.value = Number.isFinite(notional) ? notional.toFixed(2) : '';
        }
        positionSizeEl.textContent = fmtAuto(units);
        notionalHint.textContent   = notionalOverridden ? 'Manual override ON' : 'Auto: Units × Price. (Manual override off)';

        const maxLeverage = (freeMargin>0 && notional>0) ? (notional / freeMargin) : NaN;
        maxLevNote.textContent = Number.isFinite(maxLeverage) ? `Max leverage allowed: ${fmt(maxLeverage,2,2)}×` : 'Max leverage allowed: —';

        const requiredMargin = notional / Math.max(1, leverage);
        requiredMarginEl.textContent = sym + ' ' + fmt(requiredMargin,2,2);

        const usage = equity>0 ? (requiredMargin / equity * 100) : NaN;
        marginUsageEl.textContent = Number.isFinite(usage) ? fmt(usage,2,2)+' %' : '—';

        if (requiredMargin > freeMargin + 1e-9) {
            leverageEl.classList.add('is-invalid');
            leverageHint.textContent = 'Insufficient free margin (adjust Leverage or Notional).';
        } else {
            leverageEl.classList.remove('is-invalid');
            leverageHint.textContent = 'Kept ≤ max allowed by Free margin.';
        }

        chosenRiskEl.textContent = sym + ' ' + fmt(riskEuro,2,2);

        // -------- TAKE PROFITS (LONG) --------
        const f1=Math.max(0, toNum(tp1f.value));
        const f2=Math.max(0, toNum(tp2f.value));
        const f3=Math.max(0, toNum(tp3f.value));
        const tp1p = price + stop * f1;
        const tp2p = price + stop * f2;
        const tp3p = price + stop * f3;

        tp1.textContent = sym + ' ' + fmtAuto(tp1p);
        tp2.textContent = sym + ' ' + fmtAuto(tp2p);
        tp3.textContent = sym + ' ' + fmtAuto(tp3p);

        const pct1 = ((tp1p - price)/price)*100;
        const pct2 = ((tp2p - price)/price)*100;
        const pct3 = ((tp3p - price)/price)*100;
        tp1pct.textContent = Number.isFinite(pct1) ? `( +${fmt(pct1,2,2)} % )` : '—';
        tp2pct.textContent = Number.isFinite(pct2) ? `( +${fmt(pct2,2,2)} % )` : '—';
        tp3pct.textContent = Number.isFinite(pct3) ? `( +${fmt(pct3,2,2)} % )` : '—';

        // Allocations normalizadas
        let a1=Math.max(0,toNum(tp1pctAlloc.value));
        let a2=Math.max(0,toNum(tp2pctAlloc.value));
        let a3=Math.max(0,toNum(tp3pctAlloc.value));
        let sum = a1+a2+a3;
        if (sum<=0){ a1=1; a2=0; a3=0; sum=1; }
        const n1=a1/sum, n2=a2/sum, n3=a3/sum;
        document.getElementById('allocNote').textContent =
            Math.abs(sum-100)>0.5 ? `Normalized from ${fmt(sum,0,0)}% to 100%.` : 'Must sum 100% (auto-normalized if not).';

        const u1 = units * n1, u2 = units * n2, u3 = units * n3;
        const pnl1 = u1 * (tp1p - price);
        const pnl2 = u2 * (tp2p - price);
        const pnl3 = u3 * (tp3p - price);

        tp1allocText.textContent = `Allocation: ${fmt(n1*100,0,0)}% (~ ${fmtAuto(u1)} u)`;
        tp2allocText.textContent = `Allocation: ${fmt(n2*100,0,0)}% (~ ${fmtAuto(u2)} u)`;
        tp3allocText.textContent = `Allocation: ${fmt(n3*100,0,0)}% (~ ${fmtAuto(u3)} u)`;
        tp1gainText.textContent = `${sym} ${fmt(pnl1,2,2)} gain`;
        tp2gainText.textContent = `${sym} ${fmt(pnl2,2,2)} gain`;
        tp3gainText.textContent = `${sym} ${fmt(pnl3,2,2)} gain`;

        const totalPlanned = pnl1+pnl2+pnl3;
        plannedPnl.textContent = sym + ' ' + fmt(totalPlanned,2,2);
        plannedRR.textContent  = riskEuro>0 ? fmt(totalPlanned/riskEuro,2,2) + ' R' : '—';
    }

    // Listeners
    [priceEl, atrEl].forEach(el => el.addEventListener('input', ()=>{ kOverridden=false; update(); }));
    kInput.addEventListener('input', ()=>{ kOverridden=true; update(); });
    kScale.querySelectorAll('.card').forEach(card=>{
        card.style.cursor='pointer';
        card.addEventListener('click', ()=>{
            const t=card.querySelector('.title')?.textContent.trim()||'';
            let k=1.0;
            if (t.startsWith('ATR%')) k=1.75;
            else if (t==='1–2') k=1.25;
            else if (t==='2–3') k=0.90;
            else if (t==='3–5') k=0.60;
            else k=0.35;
            kInput.value=k.toFixed(2); kOverridden=true; update();
        });
    });
    resetKBtn.addEventListener('click', ()=>{ kOverridden=false; update(); });

    // Notional editable
    notionalInput.addEventListener('input', ()=>{ notionalOverridden = true; update(); });
    notionalAutoBtn.addEventListener('click', ()=>{ notionalOverridden = false; update(); });

    equityEl.addEventListener('input', ()=>{ syncRiskEuro(); update(); });
    riskPctEl.addEventListener('input', ()=>{ syncRiskEuro(); update(); });
    leverageEl.addEventListener('input', update);
    freeMarginEl.addEventListener('input', update);
    riskAbsEl.addEventListener('input', update);

    [tp1f, tp2f, tp3f].forEach(el => el.addEventListener('input', update));
    tpPreset.addEventListener('change', ()=>{ applyPreset(tpPreset.value); update(); });

    tpAllocPreset.addEventListener('change', ()=>{ applyAllocPreset(tpAllocPreset.value); update(); });
    [tp1pctAlloc, tp2pctAlloc, tp3pctAlloc].forEach(el => el.addEventListener('input', update));

    currencySelect.addEventListener('change', ()=>applyCurrencySymbol(currencySelect.value));

    // Buttons
    document.getElementById('resetBtn').addEventListener('click', ()=>{
        priceEl.value=''; atrEl.value='';
        riskAbsEl.value='500'; equityEl.value='100000'; riskPctEl.value='0.5';
        leverageEl.value='1.00'; freeMarginEl.value='1000';
        tpPreset.value='moderate'; applyPreset('moderate');
        tpAllocPreset.value='conservative'; applyAllocPreset('conservative');
        kOverridden=false; kInput.value='1.00';
        currencySelect.value='$'; applyCurrencySymbol('$');
        notionalOverridden=false; notionalInput.value='';
        notionalHint.textContent='Auto: Units × Price. (Manual override off)';
        update(); priceEl.focus();
    });
    document.getElementById('prefillBtn').addEventListener('click', ()=>{
        priceEl.value='50000'; atrEl.value='1000';
        riskAbsEl.value='600'; equityEl.value='100000'; riskPctEl.value='0.5';
        leverageEl.value='2.00'; freeMarginEl.value='1500';
        tpPreset.value='moderate'; applyPreset('moderate');
        tpAllocPreset.value='conservative'; applyAllocPreset('conservative');
        kOverridden=false; notionalOverridden=false; update();
    });

    // init
    applyPreset('moderate');
    applyAllocPreset('conservative');
    applyCurrencySymbol('$');
</script>
</body>
</html>
